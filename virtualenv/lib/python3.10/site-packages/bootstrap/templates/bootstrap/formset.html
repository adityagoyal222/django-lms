{% extends "bootstrap/base.html" %}

{% load i18n %}

{% block head %}
    {{ block.super }}
    <script type="text/javascript">
        function increase_field_attribute_index(input, attr, index)
        {
            var value = input.attr(attr);
            var new_index = ''+(index + 1);

            var value_regex = new RegExp(index + '(-[^-]+)$');
            var new_value = value.replace(value_regex, new_index + '$1');

            input.attr(attr, new_value);
        }

        $('a#plus_one').live('click', function(){
            var form = $('form');
            var last_fieldset = form.find('fieldset:last');
            var new_fieldset = last_fieldset.clone();

            var fieldset_num = form.find('fieldset').length;
            var fieldset_index = fieldset_num - 1;

            new_fieldset.find(':input').each(function(i,e){
                var input = $(e);

                // Remove data
                input.val('');

                // Increase field attributes
                increase_field_attribute_index(input, 'id', fieldset_index);
                increase_field_attribute_index(input, 'name', fieldset_index);

                var label = input.parent().prev('label');

                if (label.length > 0)
                {
                    increase_field_attribute_index(label, 'for', fieldset_index);
                }
            });

            // Remove error messages
            new_fieldset.find('.clearfix').attr('class', 'clearfix');
            new_fieldset.find('.help-inline').remove();

            var max_num = parseInt(form.find('input[name$=MAX_NUM_FORMS]').val());
            var min_num = 1;

            if (fieldset_num >= max_num)
            {
                // Does not add if fieldset_num is greater than max_num
                return;
            }

            if (fieldset_num == 1)
            {
                var minus_one_button = $('<a/>').attr('href', 'javascript:void(0)')
                                                .attr('class', 'minus_one')
                                                .html('{% blocktrans with model_verbose_name|lower as object_name %}Remove {{ object_name }}{% endblocktrans %}');

                new_fieldset.append($('<div/>').attr('class', 'clearfix')
                                               .append($('<div/>').attr('class', 'input')
                                                                  .append(minus_one_button)));
            }

            last_fieldset.after(new_fieldset);

            // Increase TOTAL_FORMS
            var total_forms = form.find('input[name$=TOTAL_FORMS]');
            total_forms.val(parseInt(total_forms.val()) + 1);
        });

        $('a.minus_one').live('click', function(){
            if ( ! confirm('{% blocktrans with model_verbose_name|lower as object_name %}Remove {{ object_name }}{% endblocktrans %}?'))
            {
                return;
            }

            var this_fieldset = $(this).closest('fieldset');
            var form = this_fieldset.closest('form');

            var fieldset_num = form.find('fieldset').length;
            var min_num = 1;

            if (fieldset_num <= min_num)
            {
                // Does not remove if fieldset_num is lesser than min_num
                return;
            }

            // Check hidden DELETE checkbox
            this_fieldset.find('input[name$=DELETE]:checkbox').attr('checked', true);

            // Remove fieldset
            this_fieldset.hide();
        });

        $(function(){
            $('input[name$=DELETE]:checkbox').each(function(){
                $(this).closest('.clearfix').hide();
            });
        });
    </script>
{% endblock %}

{% block page_header %}
    <h1>{{ model_verbose_name_plural }}</h1>
{% endblock %}

{% block button_bar %}
    <a href="javascript:void(0)" class="btn" id=plus_one>{% blocktrans with model_verbose_name|lower as object_name %}Add other {{ object_name }}{% endblocktrans %}</a>
{% endblock %}

{% block content %}
    <form action="" method="POST"> 
        {% block form %}
        {% csrf_token %}
        {% with form as formset %}
            {{ formset.management_form }}
            {% for form in formset %}
                <fieldset>
                    <legend>{% block formset_legend %}{{ model_verbose_name }}{% endblock %}</legend>
                    {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                    {% endfor %}
                    {% for field in form.visible_fields %}
                    <div class="clearfix{% if field.errors %} error{% endif %}"> 
                        {{ field.label_tag }}
                        <div class="input"> 
                            {{ field }}
                            {% if field.errors %}
                                {% for error in field.errors %}
                                    <span class="help-inline">{{ error }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="help-inline">{{ field.help_text }}</span>
                            {% endif %}
                        </div> 
                    </div><!-- /clearfix -->
                    {% endfor %}

                    {% if not forloop.first %}
                    <div class="clearfix"> 
                        <div class="input">
                            <a href="javascript:void(0)" class="minus_one">{% blocktrans with model_verbose_name|lower as object_name %}Remove {{ object_name }}{% endblocktrans %}</a>
                        </div> 
                    </div><!-- /clearfix -->
                    {% endif %}
                </fieldset>
            {% endfor %}
        {% endwith %}
        <div class="actions">
            {% block actions %}
            <button type="submit" class="btn primary">{% trans "Save" %}</button>
            <a href="{{ success_url }}" class="btn">{% trans "Cancel" %}</a>
            {% endblock %}
        </div>
        {% endblock %}
    </form>
{% endblock %}
